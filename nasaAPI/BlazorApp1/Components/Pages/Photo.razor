@page "/"
@rendermode InteractiveServer
@inject IHttpClientFactory HttpClientFactory
@inject IConfiguration Configuration
@using System.Text.Json.Serialization

<div style="display: flex; flex-direction: column; min-height: 100vh; padding: 20px;">
    <div style="align-self: center; margin-bottom: 20px;">
        <input type="date"
               value="@date"
               @onchange="OnDateChanged"
               max="@today"
               style="padding: 8px; font-size: 16px;" />
    </div>

    <div style="flex: 1; display: flex; flex-direction: column; justify-content: center; align-items: center; gap: 20px;">
        @if (loading)
        {
            <h1>Loading...</h1>
        }
        @if (!string.IsNullOrEmpty(error))
        {
            <p style="color: red;">@error</p>
        }
        @if (data != null && !loading && string.IsNullOrEmpty(error))
        {
            <h1>@data.Title</h1>
            @if (data.MediaType == "image")
            {
                <div style="position: relative; max-width: 80%; height: auto;">
                    <img src="@data.Url"
                         alt="@data.Title"
                         style="border-radius: 10px; width: 100%; height: auto;" />
                </div>
            }
            else if (data.MediaType == "video")
            {
                <iframe src="@data.Url"
                        title="@data.Title"
                        style="width: 80%; height: 450px; border: none;"
                        allowfullscreen>
                </iframe>
            }
            else
            {
                <p>Media non disponibile</p>
            }
            @if (!string.IsNullOrEmpty(data.Explanation))
            {
                <p style="max-width: 600px; text-align: justify;">@data.Explanation</p>
            }
        }
    </div>
</div>

@code {
    private string today = DateTime.Today.ToString("yyyy-MM-dd");
    private string date = DateTime.Today.ToString("yyyy-MM-dd");
    private NasaAPODData? data;
    private bool loading = false;
    private string? error;
    private string? apiKey;
    private string? baseUrl;

    protected override async Task OnInitializedAsync()
    {
        apiKey = Configuration["NasaApi:ApiKey"];
        baseUrl = Configuration["NasaApi:BaseUrl"];
        await LoadData();
    }

    private async Task OnDateChanged(ChangeEventArgs e)
    {
        date = e.Value?.ToString() ?? today;
        await LoadData();
    }

    private async Task LoadData()
    {
        if (string.IsNullOrEmpty(date) || string.IsNullOrEmpty(apiKey)) return;

        loading = true;
        error = null;

        try
        {
            var httpClient = HttpClientFactory.CreateClient();
            var url = $"{baseUrl}?api_key={apiKey}&date={date}";
            data = await httpClient.GetFromJsonAsync<NasaAPODData>(url);
        }
        catch (Exception ex)
        {
            Console.WriteLine(ex);
            error = "NessunImmagineInQuestaData.";
        }
        finally
        {
            loading = false;
        }
    }

    public class NasaAPODData
    {
        [JsonPropertyName("title")]
        public string Title { get; set; } = string.Empty;

        [JsonPropertyName("url")]
        public string Url { get; set; } = string.Empty;

        [JsonPropertyName("media_type")]
        public string MediaType { get; set; } = string.Empty;

        [JsonPropertyName("explanation")]
        public string? Explanation { get; set; }

        [JsonPropertyName("date")]
        public string Date { get; set; } = string.Empty;
    }
}